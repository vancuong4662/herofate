<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhiệm vụ - Hero Fate</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-scroll"></i> Nhiệm vụ</h1>
        </div>

        <!-- User Info Bar -->
        <div class="game-info">
            <div class="info-item">
                <i class="fas fa-star"></i>
                <span>Cấp độ: <strong id="userLevel">1</strong></span>
            </div>
            <div class="info-item">
                <i class="fas fa-coins"></i>
                <span>Vàng: <strong id="userGold">0</strong></span>
            </div>
            <div class="info-item">
                <i class="fas fa-bolt"></i>
                <span>EXP: <strong id="userExp">0</strong></span>
            </div>
            <div class="info-item">
                <i class="fas fa-heart"></i>
                <span>Danh tiếng: <strong id="userReputation">0</strong></span>
            </div>
        </div>

        <!-- Quests Container -->
        <div id="questsContainer" style="margin-bottom: 20px;">
            <!-- Quests will be loaded by JavaScript -->
        </div>

        <!-- Navigation -->
        <div style="text-align: center; margin-top: 20px;">
            <div style="background: rgba(255,255,255,0.9); padding: 15px; border-radius: 10px; display: inline-block;">
                <a href="/town" class="btn" style="margin: 5px;">
                    <i class="fas fa-city"></i> Thị trấn
                </a>
                <a href="/quests" class="btn btn-warning" style="margin: 5px;">
                    <i class="fas fa-scroll"></i> Nhiệm vụ
                </a>
                <a href="/battle" class="btn" style="margin: 5px;">
                    <i class="fas fa-sword"></i> Chiến đấu
                </a>
            </div>
        </div>
    </div>

    <script src="/static/js/main.js"></script>
    <script>
        // Quest functions
        async function loadQuests() {
            try {
                const userData = getUserData();
                if (!userData) {
                    window.location.href = '/';
                    return;
                }
                
                const response = await apiCall('/api/quests');
                const allQuests = response.quests;
                const userQuests = userData.quests || [];
                
                const container = document.getElementById('questsContainer');
                container.innerHTML = '';
                
                // Show user's active quests
                const activeQuests = userQuests.filter(uq => uq.state === 'doing');
                if (activeQuests.length > 0) {
                    const activeSection = document.createElement('div');
                    activeSection.innerHTML = '<h3 style="color: white; margin-bottom: 15px;"><i class="fas fa-play"></i> Nhiệm vụ đang thực hiện</h3>';
                    
                    activeQuests.forEach(userQuest => {
                        const quest = allQuests.find(q => q.quest_id === userQuest.quest_id);
                        if (quest) {
                            const questCard = createQuestCard(quest, 'doing');
                            activeSection.appendChild(questCard);
                        }
                    });
                    
                    container.appendChild(activeSection);
                }
                
                // Show available quests
                const availableQuests = allQuests.filter(quest => {
                    const userLevel = calculateLevel(userData.exp || 0);
                    const hasQuest = userQuests.some(uq => uq.quest_id === quest.quest_id);
                    return quest.level_required <= userLevel && !hasQuest;
                });
                
                if (availableQuests.length > 0) {
                    const availableSection = document.createElement('div');
                    availableSection.innerHTML = '<h3 style="color: white; margin-bottom: 15px; margin-top: 30px;"><i class="fas fa-plus"></i> Nhiệm vụ có thể nhận</h3>';
                    
                    availableQuests.slice(0, 5 - activeQuests.length).forEach(quest => {
                        const questCard = createQuestCard(quest, 'available');
                        availableSection.appendChild(questCard);
                    });
                    
                    container.appendChild(availableSection);
                }
                
                // Update user info display
                updateUserInfoDisplay(userData);
                
            } catch (error) {
                console.error('Error loading quests:', error);
            }
        }

        function createQuestCard(quest, state) {
            const card = document.createElement('div');
            card.style.cssText = `
                background: rgba(255, 255, 255, 0.9);
                border-radius: 10px;
                padding: 20px;
                margin-bottom: 15px;
                position: relative;
            `;
            
            const stateClass = state === 'doing' ? 'btn-warning' : 'btn-success';
            const stateText = state === 'doing' ? 'Đang thực hiện' : 'Có thể nhận';
            const buttonText = state === 'doing' ? 'Tiếp tục' : 'Bắt đầu';
            
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h4 style="color: #2c3e50; margin: 0 0 10px 0;">${quest.name}</h4>
                        <p style="color: #7f8c8d; margin: 0 0 15px 0; line-height: 1.4;">${quest.description}</p>
                        
                        <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                            <div><i class="fas fa-coins"></i> ${quest.reward.gold} vàng</div>
                            <div><i class="fas fa-bolt"></i> ${quest.reward.exp} EXP</div>
                            <div><i class="fas fa-star"></i> Cấp ${quest.level_required}+</div>
                        </div>
                        
                        ${quest.reward.items && quest.reward.items.length > 0 ? 
                            `<div style="margin-bottom: 15px;">
                                <strong>Phần thưởng item:</strong> 
                                ${quest.reward.items.map(item => `${item.item_id} x${item.quantity}`).join(', ')}
                            </div>` : ''
                        }
                        
                        ${quest.required_items && quest.required_items.length > 0 ? 
                            `<div style="margin-bottom: 15px;">
                                <strong>Cần thu thập:</strong> 
                                ${quest.required_items.map(item => `${item.item_id} x${item.quantity}`).join(', ')}
                            </div>` : ''
                        }
                    </div>
                    
                    <div style="text-align: center;">
                        <div class="btn ${stateClass}" style="margin-bottom: 10px; padding: 8px 16px; font-size: 0.9em;">
                            ${stateText}
                        </div>
                        <button class="btn" onclick="startQuest('${quest.quest_id}')" style="display: block; width: 100%;">
                            <i class="fas fa-play"></i> ${buttonText}
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }

        function startQuest(questId) {
            // For now, just show a message
            showToast('Tính năng này đang được phát triển!', 'warning');
        }

        // Check if user is logged in and load quests
        document.addEventListener('DOMContentLoaded', function() {
            const userData = getUserData();
            if (!userData) {
                window.location.href = '/';
                return;
            }
            
            loadQuests();
        });
    </script>
</body>
</html>
