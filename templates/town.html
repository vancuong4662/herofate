<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th·ªã Tr·∫•n - Hero Fate</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Huninn&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1><img src="/static/img/icon/button/town.png" style="width: 48px; height: 48x; object-fit: contain; margin-right: 10px; vertical-align: middle;" alt="Town"> Th·ªã Tr·∫•n</h1>
        </div>

        <!-- User Info & Navigation Bar -->
        <div class="game-info-nav">
            <!-- User Stats -->
            <div class="user-stats">
                <div class="info-item">
                    <img src="/static/img/icon/info/exp.png" style="width: 16px; height: 16px; object-fit: contain; margin-right: 5px; vertical-align: middle;" alt="Level">
                    <span>C·∫•p ƒë·ªô: <strong id="userLevel">1</strong></span>
                </div>
                <div class="info-item">
                    <img src="/static/img/icon/info/gold.png" style="width: 16px; height: 16px; object-fit: contain; margin-right: 5px; vertical-align: middle;" alt="Gold">
                    <span>V√†ng: <strong id="userGold">0</strong></span>
                </div>
                <div class="info-item">
                    <img src="/static/img/icon/info/exp.png" style="width: 16px; height: 16px; object-fit: contain; margin-right: 5px; vertical-align: middle;" alt="EXP">
                    <span>EXP: <strong id="userExp">0</strong></span>
                </div>
                <div class="info-item">
                    <img src="/static/img/icon/info/reputation.png" style="width: 16px; height: 16px; object-fit: contain; margin-right: 5px; vertical-align: middle;" alt="Reputation">
                    <span>Danh ti·∫øng: <strong id="userReputation">0</strong></span>
                </div>
            </div>
            
            <!-- Navigation Actions -->
            <div class="nav-actions">
                <button class="btn btn-primary btn-icon" onclick="showPlayerInfo()">
                    <img src="/static/img/icon/button/info.png" alt="Info"> Th√¥ng tin
                </button>
                <button class="btn btn-secondary btn-icon" onclick="logout()">
                    <img src="/static/img/icon/button/logout.png" alt="Logout"> ƒêƒÉng xu·∫•t
                </button>
            </div>
        </div>

        <!-- Buildings Grid -->
        <div class="buildings-grid" id="buildingsContainer">
            <!-- Buildings will be loaded by JavaScript -->
        </div>
    </div>

    <!-- Player Info Modal -->
    <div id="playerInfoModal" class="modal">
        <div class="modal-content player-info-modal">
            <!-- Modal Header -->
            <div class="modal-header">
                <h2 class="modal-title">
                    <img src="/static/img/icon/info/user.png" style="width: 20px; height: 20px; object-fit: contain; margin-right: 8px; vertical-align: middle;" alt="User"> Th√¥ng tin nh√¢n v·∫≠t
                </h2>
                <button class="modal-close" onclick="closeModal()">
                    <img src="/static/img/icon/button/close.png" style="width: 16px; height: 16px; object-fit: contain;" alt="Close">
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="modal-body">
                <div class="player-info-container">
                    <!-- Left Side - Avatar -->
                    <div class="player-info-avatar">
                        <canvas id="playerInfoCanvas" width="128" height="128"></canvas>
                        <div class="avatar-label">
                            <img src="/static/img/icon/info/user.png" style="width: 16px; height: 16px; object-fit: contain; margin-right: 5px; vertical-align: middle;" alt="Player">
                            <span id="playerUsername">T√™n t√†i kho·∫£n</span>
                        </div>
                    </div>
                    
                    <!-- Right Side - Stats & Info -->
                    <div class="player-info-stats">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <img src="/static/img/icon/info/exp.png" style="width: 16px; height: 16px; object-fit: contain;" alt="Level">
                                <div class="stat-content">
                                    <span class="stat-label">C·∫•p ƒë·ªô</span>
                                    <span class="stat-value" id="playerInfoLevel">1</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <img src="/static/img/icon/info/gold.png" style="width: 16px; height: 16px; object-fit: contain;" alt="Gold">
                                <div class="stat-content">
                                    <span class="stat-label">V√†ng</span>
                                    <span class="stat-value" id="playerInfoGold">0</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <img src="/static/img/icon/info/exp.png" style="width: 16px; height: 16px; object-fit: contain;" alt="EXP">
                                <div class="stat-content">
                                    <span class="stat-label">Kinh nghi·ªám</span>
                                    <span class="stat-value" id="playerInfoExp">0</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <img src="/static/img/icon/info/reputation.png" style="width: 16px; height: 16px; object-fit: contain;" alt="Reputation">
                                <div class="stat-content">
                                    <span class="stat-label">Danh ti·∫øng</span>
                                    <span class="stat-value" id="playerInfoReputation">0</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <img src="/static/img/icon/info/stat/str.png" style="width: 16px; height: 16px; object-fit: contain;" alt="STR">
                                <div class="stat-content">
                                    <span class="stat-label">S·ª©c m·∫°nh (STR)</span>
                                    <span class="stat-value" id="playerInfoSTR">10</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <img src="/static/img/icon/info/stat/agi.png" style="width: 16px; height: 16px; object-fit: contain;" alt="AGI">
                                <div class="stat-content">
                                    <span class="stat-label">Nhanh nh·∫πn (AGI)</span>
                                    <span class="stat-value" id="playerInfoAGI">10</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <img src="/static/img/icon/info/stat/int.png" style="width: 16px; height: 16px; object-fit: contain;" alt="INT">
                                <div class="stat-content">
                                    <span class="stat-label">Tr√≠ tu·ªá (INT)</span>
                                    <span class="stat-value" id="playerInfoINT">10</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <img src="/static/img/icon/info/stat/vit.png" style="width: 16px; height: 16px; object-fit: contain;" alt="VIT">
                                <div class="stat-content">
                                    <span class="stat-label">Th·ªÉ l·ª±c (VIT)</span>
                                    <span class="stat-value" id="playerInfoVIT">10</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <img src="/static/img/icon/info/stat/wis.png" style="width: 16px; height: 16px; object-fit: contain;" alt="WIS">
                                <div class="stat-content">
                                    <span class="stat-label">Kh√¥n ngoan (WIS)</span>
                                    <span class="stat-value" id="playerInfoWIS">10</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <img src="/static/img/icon/info/stat/str.png" style="width: 16px; height: 16px; object-fit: contain;" alt="Crit">
                                <div class="stat-content">
                                    <span class="stat-label">T·ª∑ l·ªá ch√≠ m·∫°ng</span>
                                    <span class="stat-value" id="playerInfoCrit">10%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="modal-footer">
                <button class="btn btn-secondary btn-icon" onclick="closeModal()">
                    <img src="/static/img/icon/button/cancel.png" alt="Close"> ƒê√≥ng
                </button>
            </div>
        </div>
    </div>

    <!-- Building Modal -->
    <div id="buildingModal" class="modal">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h2 class="modal-title" id="modalBuildingName">T√™n c√¥ng tr√¨nh</h2>
                <button class="modal-close" onclick="closeModal()">
                    <img src="/static/img/icon/button/close.png" style="width: 16px; height: 16px; object-fit: contain;" alt="Close">
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="modal-body">
                <p id="modalBuildingDescription">M√¥ t·∫£ c√¥ng tr√¨nh</p>
                
                <div id="upgradeInfo">
                    <!-- Upgrade information will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="modal-footer">
                <button id="upgradeButton" class="btn btn-primary btn-icon">
                    <img src="/static/img/icon/button/build.png" alt="Build"> X√¢y d·ª±ng
                </button>
                <button class="btn btn-secondary btn-icon" onclick="closeModal()">
                    <img src="/static/img/icon/button/cancel.png" alt="Close"> ƒê√≥ng
                </button>
            </div>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div id="inventoryModal" class="modal inventory-modal">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h2 class="modal-title">
                    <img src="/static/img/icon/button/inventory.png" style="width: 20px; height: 20px; object-fit: contain; margin-right: 8px; vertical-align: middle;" alt="Inventory"> Kho ƒë·ªì
                </h2>
                <button class="modal-close" onclick="closeModal()">
                    <img src="/static/img/icon/button/close.png" style="width: 16px; height: 16px; object-fit: contain;" alt="Close">
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="modal-body">
                <div class="inventory-container">
                    <!-- Main Inventory Panel (70%) -->
                    <div class="inventory-main">
                        <div class="inventory-tabs">
                            <button class="btn btn-primary btn-icon" onclick="showInventoryTab('equipment')">
                                <img src="/static/img/icon/button/blacksmith.png" alt="Equipment"> Trang b·ªã
                            </button>
                            <button class="btn btn-primary btn-icon" onclick="showInventoryTab('material')">
                                <img src="/static/img/icon/button/market.png" alt="Material"> Nguy√™n li·ªáu
                            </button>
                        </div>
                        
                        <div class="inventory-grid" id="inventoryGrid">
                            <!-- Inventory slots will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Item Detail Sidebar (30%) -->
                    <div class="inventory-sidebar">
                        <div class="item-detail empty" id="itemDetail">
                            <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">
                                <img src="/static/img/icon/info/user.png" style="width: 32px; height: 32px; object-fit: contain; margin-bottom: 10px; opacity: 0.5;" alt="Select Item">
                                <p>Di chu·ªôt qua item ƒë·ªÉ xem chi ti·∫øt</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="modal-footer">
                <button id="useItemButton" class="btn btn-primary btn-icon" style="display: none;" onclick="useSelectedItem()">
                    <img src="/static/img/icon/button/start.png" alt="Use"> S·ª≠ d·ª•ng
                </button>
                <button class="btn btn-secondary btn-icon" onclick="closeModal()">
                    <img src="/static/img/icon/button/cancel.png" alt="Close"> ƒê√≥ng
                </button>
            </div>
        </div>
    </div>

    <script src="/static/js/support.js"></script>
    <script src="/static/js/gml.js"></script>
    <script src="/static/js/main.js"></script>
    <script>
        // Player Animation Configuration
        const ANIMATION_CONFIG = {
            FRAME_SPEED: 0.1,        // T·ªëc ƒë·ªô chuy·ªÉn frame (0.05 = ch·∫≠m, 0.3 = nhanh)
            FRAME_COUNT: 4,          // S·ªë frame trong sprite
            CANVAS_SIZE: 128,        // K√≠ch th∆∞·ªõc canvas
            SPRITE_SIZE: 128,        // K√≠ch th∆∞·ªõc m·ªói frame sprite
            AUTO_START: false        // T·ª± ƒë·ªông b·∫Øt ƒë·∫ßu animation khi load page
        };

        // Player Animation System
        let playerSprite = null;
        let playerInstance = null;
        let playerCanvas = null;
        let playerCtx = null;
        let animationRunning = false;

        function initPlayerAnimation() {
            playerCanvas = document.getElementById('playerInfoCanvas');
            if (!playerCanvas) {
                console.error('Player canvas not found');
                return;
            }
            
            playerCtx = playerCanvas.getContext('2d');
            
            // Create player sprite with configurable parameters
            playerSprite = spriteCreate(
                '/static/img/player/male_idle.png', 
                ANIMATION_CONFIG.SPRITE_SIZE, 
                ANIMATION_CONFIG.SPRITE_SIZE, 
                ANIMATION_CONFIG.FRAME_COUNT, 
                ANIMATION_CONFIG.SPRITE_SIZE / 2, 
                ANIMATION_CONFIG.SPRITE_SIZE / 2
            );
            
            // Wait for image to load
            playerSprite.image.onload = function() {
                // Create player instance with configurable speed
                playerInstance = instCreate(
                    ANIMATION_CONFIG.CANVAS_SIZE / 2, 
                    ANIMATION_CONFIG.CANVAS_SIZE / 2, 
                    0, 
                    playerSprite
                );
                playerInstance.imageSpeed = ANIMATION_CONFIG.FRAME_SPEED;
                playerInstance.imageLoop = true;
                
                // Auto start if configured
                if (ANIMATION_CONFIG.AUTO_START) {
                    startPlayerAnimation();
                }
            };
            
            playerSprite.image.onerror = function() {
                console.error('Failed to load player sprite');
                drawFallbackPlayer();
            };
        }

        function startPlayerAnimation() {
            if (animationRunning) return;
            animationRunning = true;
            
            function animate() {
                if (!animationRunning || !playerInstance || !playerCanvas) return;
                
                // Clear canvas
                playerCtx.clearRect(0, 0, playerCanvas.width, playerCanvas.height);
                
                // Update animation frame using configurable speed
                playerInstance.imageFrameCounter += playerInstance.imageSpeed;
                if (playerInstance.imageFrameCounter >= 1) {
                    playerInstance.imageIndex = (playerInstance.imageIndex + 1) % ANIMATION_CONFIG.FRAME_COUNT;
                    playerInstance.imageFrameCounter = 0;
                }
                
                // Draw player sprite at full size (128x128)
                drawPlayerFrame();
                
                // Continue animation
                requestAnimationFrame(animate);
            }
            
            animate();
        }

        function drawPlayerFrame() {
            if (!playerSprite || !playerInstance) return;
            
            const frameX = (playerInstance.imageIndex % ANIMATION_CONFIG.FRAME_COUNT) * ANIMATION_CONFIG.SPRITE_SIZE;
            const frameY = 0; // Single row of frames
            
            // Draw at configured canvas size
            const drawWidth = ANIMATION_CONFIG.SPRITE_SIZE;
            const drawHeight = ANIMATION_CONFIG.SPRITE_SIZE;
            const drawX = (ANIMATION_CONFIG.CANVAS_SIZE - drawWidth) / 2;
            const drawY = (ANIMATION_CONFIG.CANVAS_SIZE - drawHeight) / 2;
            
            playerCtx.drawImage(
                playerSprite.image,
                frameX, frameY, ANIMATION_CONFIG.SPRITE_SIZE, ANIMATION_CONFIG.SPRITE_SIZE,
                drawX, drawY, drawWidth, drawHeight
            );
        }

        function drawFallbackPlayer() {
            if (!playerCtx) return;
            playerCtx.fillStyle = '#3498db';
            playerCtx.fillRect(0, 0, ANIMATION_CONFIG.CANVAS_SIZE, ANIMATION_CONFIG.CANVAS_SIZE);
            playerCtx.fillStyle = 'white';
            playerCtx.font = '40px Arial';
            playerCtx.textAlign = 'center';
            playerCtx.fillText('üë§', ANIMATION_CONFIG.CANVAS_SIZE/2, ANIMATION_CONFIG.CANVAS_SIZE/2 + 15);
        }

        // Animation Control Functions
        /**
         * ƒêi·ªÅu ch·ªânh t·ªëc ƒë·ªô animation c·ªßa avatar
         * @param {number} speed - T·ªëc ƒë·ªô (0.05 = r·∫•t ch·∫≠m, 0.15 = b√¨nh th∆∞·ªùng, 0.3 = r·∫•t nhanh)
         * V√≠ d·ª•: setAnimationSpeed(0.1); // ƒê·∫∑t t·ªëc ƒë·ªô ch·∫≠m
         */
        function setAnimationSpeed(speed) {
            ANIMATION_CONFIG.FRAME_SPEED = speed;
            if (playerInstance) {
                playerInstance.imageSpeed = speed;
            }
            console.log(`Animation speed set to: ${speed}`);
        }

        /**
         * L·∫•y t·ªëc ƒë·ªô animation hi·ªán t·∫°i
         * @returns {number} T·ªëc ƒë·ªô hi·ªán t·∫°i
         */
        function getAnimationSpeed() {
            return ANIMATION_CONFIG.FRAME_SPEED;
        }

        /**
         * S·ª≠ d·ª•ng preset t·ªëc ƒë·ªô animation c√≥ s·∫µn
         * @param {string} preset - Preset: 'very_slow', 'slow', 'normal', 'fast', 'very_fast'
         * V√≠ d·ª•: setAnimationPreset('slow'); // ƒê·∫∑t t·ªëc ƒë·ªô ch·∫≠m
         */
        // Preset animation speeds
        function setAnimationPreset(preset) {
            const presets = {
                'very_slow': 0.05,
                'slow': 0.1,
                'normal': 0.15,
                'fast': 0.2,
                'very_fast': 0.3
            };
            
            if (presets[preset]) {
                setAnimationSpeed(presets[preset]);
            } else {
                console.error(`Unknown preset: ${preset}. Available: very_slow, slow, normal, fast, very_fast`);
            }
        }

        /*
         * H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG ANIMATION SYSTEM:
         * 
         * 1. Thay ƒë·ªïi t·ªëc ƒë·ªô animation:
         *    setAnimationSpeed(0.1);  // T·ªëc ƒë·ªô ch·∫≠m
         *    setAnimationSpeed(0.15); // T·ªëc ƒë·ªô b√¨nh th∆∞·ªùng
         *    setAnimationSpeed(0.2);  // T·ªëc ƒë·ªô nhanh
         * 
         * 2. S·ª≠ d·ª•ng preset c√≥ s·∫µn:
         *    setAnimationPreset('slow');    // Ch·∫≠m
         *    setAnimationPreset('normal');  // B√¨nh th∆∞·ªùng
         *    setAnimationPreset('fast');    // Nhanh
         * 
         * 3. Ki·ªÉm tra t·ªëc ƒë·ªô hi·ªán t·∫°i:
         *    console.log(getAnimationSpeed());
         * 
         * 4. D·ª´ng/kh·ªüi ƒë·ªông animation:
         *    stopPlayerAnimation();   // D·ª´ng
         *    startPlayerAnimation();  // Kh·ªüi ƒë·ªông
         */

        function stopPlayerAnimation() {
            animationRunning = false;
        }

        // Player Info Modal functions
        async function showPlayerInfo() {
            const modal = document.getElementById('playerInfoModal');
            const userData = getUserData();
            
            if (!userData) {
                showToast('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin ng∆∞·ªùi ch∆°i', 'error');
                return;
            }
            
            // Update player info in modal
            document.getElementById('playerUsername').textContent = userData.username;
            document.getElementById('playerInfoLevel').textContent = Math.floor(userData.exp / 100) + 1;
            document.getElementById('playerInfoGold').textContent = userData.gold || 0;
            document.getElementById('playerInfoExp').textContent = userData.exp || 0;
            document.getElementById('playerInfoReputation').textContent = userData.reputation || 0;
            
            // Update stats
            const stats = userData.stats || {};
            document.getElementById('playerInfoSTR').textContent = stats.STR || 10;
            document.getElementById('playerInfoAGI').textContent = stats.AGI || 10;
            document.getElementById('playerInfoINT').textContent = stats.INT || 10;
            document.getElementById('playerInfoVIT').textContent = stats.VIT || 10;
            document.getElementById('playerInfoWIS').textContent = stats.WIS || 10;
            document.getElementById('playerInfoCrit').textContent = Math.round((stats.crit_rate || 0.1) * 100) + '%';
            
            // Show modal
            modal.style.display = 'block';
            
            // Start player animation
            if (!animationRunning) {
                startPlayerAnimation();
            }
        }

        // Close modal function (enhanced)
        function closeModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.style.display = 'none';
            });
            
            // Stop player animation when modal closes
            if (animationRunning) {
                stopPlayerAnimation();
            }
        }

        // Initialize player animation system when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize sprite but don't start animation yet
            setTimeout(initPlayerAnimation, 100);
        });

        // Inventory functions
        let selectedItem = null;
        let currentTab = 'material';
        
        async function showInventory() {
            const modal = document.getElementById('inventoryModal');
            modal.style.display = 'block';
            showInventoryTab('material'); // Default to materials tab
        }

        function getItemTypeVietnamese(type) {
            const typeMap = {
                'material': 'Nguy√™n li·ªáu',
                'equipment': 'Trang b·ªã',
                'consumable': 'V·∫≠t ph·∫©m ti√™u hao',
                'weapon': 'V≈© kh√≠',
                'armor': 'Gi√°p',
                'accessory': 'Ph·ª• ki·ªán'
            };
            return typeMap[type] || type;
        }

        function getItemIcon(itemData) {
            // Return path to png icon image
            return `/static/img/icon/item/${itemData.item_id}.png`;
        }

        function getItemIconFallback(itemData) {
            // Fallback font awesome icons if image fails to load
            if (itemData.type === 'equipment') {
                return 'fas fa-sword';
            } else if (itemData.type === 'material') {
                const materialIcons = {
                    'wood': 'fas fa-tree',
                    'stone': 'fas fa-mountain',
                    'iron': 'fas fa-hammer',
                    'coal': 'fas fa-fire',
                    'herb': 'fas fa-leaf',
                    'crystal': 'fas fa-gem',
                    'mana_stone': 'fas fa-star',
                    'diamond': 'fas fa-diamond'
                };
                return materialIcons[itemData.item_id] || 'fas fa-cube';
            }
            return 'fas fa-question';
        }

        async function showInventoryTab(type) {
            currentTab = type;
            const userData = getUserData();
            const inventory = userData.inventory || [];
            const grid = document.getElementById('inventoryGrid');
            
            // Reset selected item
            selectedItem = null;
            updateItemDetail(null);
            updateUseButton();
            
            try {
                // Load items data to get proper names and info
                const response = await apiCall('/api/items');
                const allItems = response.items;
                
                // Create 36 slots (6x6 grid)
                const totalSlots = 36;
                let html = '';
                
                // Filter items by type
                const filteredItems = inventory.filter(item => {
                    const itemData = allItems.find(i => i.item_id === item.item_id);
                    return itemData && itemData.type === type;
                });
                
                // Fill slots
                for (let i = 0; i < totalSlots; i++) {
                    const item = filteredItems[i];
                    
                    if (item) {
                        const itemData = allItems.find(i => i.item_id === item.item_id);
                        if (itemData) {
                            const iconPath = getItemIcon(itemData);
                            const fallbackIcon = getItemIconFallback(itemData);
                            
                            html += `
                                <div class="inventory-slot" 
                                     data-item-id="${item.item_id}" 
                                     onmouseenter="showItemTooltip('${item.item_id}')" 
                                     onmouseleave="hideItemTooltip()"
                                     onclick="selectItem('${item.item_id}')">
                                    <img class="item-icon" 
                                         src="${iconPath}" 
                                         alt="${itemData.name}"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                                    <i class="item-icon fallback ${fallbackIcon}" style="display: none;"></i>
                                    <div class="item-quantity">${item.quantity}</div>
                                </div>
                            `;
                        }
                    } else {
                        html += '<div class="inventory-slot empty"></div>';
                    }
                }
                
                grid.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading items:', error);
                grid.innerHTML = '<p style="text-align: center; color: #e74c3c; grid-column: 1 / -1;">L·ªói t·∫£i d·ªØ li·ªáu item.</p>';
            }
        }

        async function showItemTooltip(itemId) {
            try {
                const response = await apiCall('/api/items');
                const allItems = response.items;
                const itemData = allItems.find(i => i.item_id === itemId);
                
                if (itemData) {
                    updateItemDetail(itemData);
                }
            } catch (error) {
                console.error('Error loading item tooltip:', error);
            }
        }

        function hideItemTooltip() {
            if (!selectedItem) {
                updateItemDetail(null);
            }
        }

        async function selectItem(itemId) {
            // Remove previous selection
            document.querySelectorAll('.inventory-slot.selected').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            // Add selection to clicked slot
            const slot = document.querySelector(`[data-item-id="${itemId}"]`);
            if (slot) {
                slot.classList.add('selected');
                selectedItem = itemId;
                
                // Show item detail
                await showItemTooltip(itemId);
                updateUseButton();
            }
        }

        function updateItemDetail(itemData) {
            const detailContainer = document.getElementById('itemDetail');
            
            if (!itemData) {
                detailContainer.className = 'item-detail empty';
                detailContainer.innerHTML = `
                    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">
                        <i class="fas fa-mouse-pointer" style="font-size: 2em; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>Di chu·ªôt qua item ƒë·ªÉ xem chi ti·∫øt</p>
                    </div>
                `;
                return;
            }
            
            detailContainer.className = 'item-detail';
            
            // Build stats display if available
            let statsHtml = '';
            if (itemData.stat && Object.keys(itemData.stat).length > 0) {
                statsHtml = '<div class="item-stats">';
                Object.entries(itemData.stat).forEach(([key, value]) => {
                    let statName = key;
                    let statValue = value;
                    
                    // Format special stats
                    if (key === 'crit_rate') {
                        statName = 'T·ª∑ l·ªá ch√≠ m·∫°ng';
                        statValue = Math.round(value * 100) + '%';
                    } else {
                        statValue = '+' + value;
                    }
                    
                    statsHtml += `<div class="stat-item"><span>${statName}:</span><span>${statValue}</span></div>`;
                });
                statsHtml += '</div>';
            }
            
            // Build level requirement if available
            const levelReq = itemData.level_require ? `<div class="item-level-req">Y√™u c·∫ßu: C·∫•p ${itemData.level_require}</div>` : '';
            
            // Build item image with fallback
            const iconPath = getItemIcon(itemData);
            const fallbackIcon = getItemIconFallback(itemData);
            
            detailContainer.innerHTML = `
                <div class="item-image">
                    <img src="${iconPath}" 
                         alt="${itemData.name}"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                    <i class="${fallbackIcon}" style="display: none;"></i>
                </div>
                <div class="item-name">${itemData.name}</div>
                <div class="item-type">${getItemTypeVietnamese(itemData.type)}</div>
                <div class="item-price"><i class="fas fa-coins"></i> ${itemData.price} v√†ng</div>
                ${levelReq}
                <div class="item-description">${itemData.description}</div>
                ${statsHtml}
            `;
        }

        function updateUseButton() {
            const useButton = document.getElementById('useItemButton');
            
            if (selectedItem) {
                // Check if selected item is equipment
                const isEquipment = currentTab === 'equipment';
                useButton.style.display = isEquipment ? 'inline-flex' : 'none';
            } else {
                useButton.style.display = 'none';
            }
        }

        async function useSelectedItem() {
            if (!selectedItem) {
                showToast('Ch∆∞a ch·ªçn item n√†o', 'error');
                return;
            }
            
            // TODO: Implement use item functionality
            showToast(`S·ª≠ d·ª•ng item: ${selectedItem}`, 'info');
        }

        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function() {
            const userData = getUserData();
            if (!userData) {
                window.location.href = '/';
                return;
            }
            
            // Load buildings and render them
            loadBuildings();
            updateUserInfoDisplay(userData);
        });

        // Load and render buildings
        async function loadBuildings() {
            try {
                const response = await apiCall('/api/buildings');
                const buildings = response.buildings;
                const userData = getUserData();
                const userBuildings = userData.buildings || {};
                
                renderBuildings(buildings, userBuildings);
            } catch (error) {
                console.error('Error loading buildings:', error);
                showToast('L·ªói khi t·∫£i th√¥ng tin c√¥ng tr√¨nh', 'error');
            }
        }

        // Render buildings as cards with appropriate buttons
        function renderBuildings(buildings, userBuildings) {
            const container = document.getElementById('buildingsContainer');
            let html = '';
            
            buildings.forEach(building => {
                const userLevel = userBuildings[building.building_id] || 0;
                const isBuilt = userLevel > 0;
                const maxLevel = Object.keys(building.upgrade_material || {}).length;
                const isMaxLevel = userLevel >= maxLevel;
                
                // Building image with level indicator
                const buildingImage = `/static/img/building/${building.building_id}.png`;
                const levelText = isBuilt ? `C·∫•p ${userLevel}` : 'Ch∆∞a x√¢y';
                
                // Building card styling
                const cardClass = isBuilt ? 'building-card built' : 'building-card not-built';
                
                // Generate buttons based on building state
                let buttonsHtml = '';
                
                if (!isBuilt) {
                    // Not built - show build button
                    buttonsHtml = `
                        <button class="btn btn-success btn-icon building-action" onclick="showBuildingModal('${building.building_id}')">
                            <img src="/static/img/icon/button/build.png" alt="Build"> X√¢y d·ª±ng
                        </button>
                    `;
                } else {
                    // Built - show feature button and upgrade button (if not max level)
                    const featureButton = getBuildingFeatureButton(building.building_id);
                    
                    buttonsHtml = `
                        <div class="building-buttons">
                            ${featureButton}
                            ${!isMaxLevel ? `
                                <button class="btn btn-primary btn-icon building-action" onclick="showBuildingModal('${building.building_id}')">
                                    <img src="/static/img/icon/button/up.png" alt="Upgrade"> N√¢ng c·∫•p
                                </button>
                            ` : ''}
                        </div>
                    `;
                }
                
                html += `
                    <div class="${cardClass}" data-building-id="${building.building_id}">
                        <div class="building-level-badge ${isBuilt ? 'built' : 'not-built'}">${levelText}</div>
                        <div class="building-image">
                            <div class="building-structure" style="background-image: url('${buildingImage}');"></div>
                        </div>
                        <div class="building-info">
                            <h3 class="building-name">${building.name}</h3>
                            <p class="building-description">${building.description}</p>
                            <div class="action-buttons">
                                ${buttonsHtml}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Get feature button for each building type
        function getBuildingFeatureButton(buildingId) {
            const featureButtons = {
                'town_hall': `
                    <button class="btn btn-success btn-icon building-feature" onclick="window.location.href='/quests'">
                        <img src="/static/img/icon/button/quest.png" alt="Quests"> Nhi·ªám v·ª•
                    </button>
                `,
                'blacksmith': `
                    <button class="btn btn-success btn-icon building-feature" onclick="showBlacksmithModal()">
                        <img src="/static/img/icon/button/blacksmith.png" alt="Forge"> R√®n
                    </button>
                `,
                'market': `
                    <button class="btn btn-success btn-icon building-feature" onclick="showMarketModal()">
                        <img src="/static/img/icon/button/market.png" alt="Shop"> Ch·ª£
                    </button>
                `,
                'storage': `
                    <button class="btn btn-success btn-icon building-feature" onclick="showInventory()">
                        <img src="/static/img/icon/button/inventory.png" alt="Storage"> Kho ƒë·ªì
                    </button>
                `,
                'mage_tower': `
                    <button class="btn btn-success btn-icon building-feature" onclick="showMageTowerModal()">
                        <img src="/static/img/icon/button/mage.png" alt="Magic"> Ph√©p thu·∫≠t
                    </button>
                `
            };
            
            return featureButtons[buildingId] || '';
        }

        // Building feature functions
        function showBlacksmithModal() {
            showToast('T√≠nh nƒÉng th·ª£ r√®n ƒëang ph√°t tri·ªÉn', 'info');
            // TODO: Implement blacksmith functionality
        }

        function showMarketModal() {
            window.location.href = '/market';
        }

        function showMageTowerModal() {
            showToast('T√≠nh nƒÉng th√°p ph√©p thu·∫≠t ƒëang ph√°t tri·ªÉn', 'info');
            // TODO: Implement mage tower functionality
        }

        // Show building modal for upgrade/build
        async function showBuildingModal(buildingId) {
            try {
                const response = await apiCall('/api/buildings');
                const buildings = response.buildings;
                const building = buildings.find(b => b.building_id === buildingId);
                
                if (!building) {
                    showToast('Kh√¥ng t√¨m th·∫•y th√¥ng tin c√¥ng tr√¨nh', 'error');
                    return;
                }
                
                const userData = getUserData();
                const userLevel = userData.buildings[buildingId] || 0;
                const nextLevel = userLevel + 1;
                const upgradeInfo = building.upgrade_material[nextLevel.toString()];
                
                if (!upgradeInfo) {
                    showToast('C√¥ng tr√¨nh ƒë√£ ƒë·∫°t c·∫•p ƒë·ªô t·ªëi ƒëa', 'info');
                    return;
                }
                
                // Update modal content
                document.getElementById('modalBuildingName').textContent = building.name;
                document.getElementById('modalBuildingDescription').textContent = building.description;
                
                // Generate upgrade info HTML
                let upgradeHtml = `
                    <div class="upgrade-section">
                        <h4>
                            <img src="/static/img/icon/button/${userLevel === 0 ? 'build' : 'up'}.png" style="width: 16px; height: 16px; object-fit: contain; margin-right: 5px; vertical-align: middle;" alt="${userLevel === 0 ? 'Build' : 'Upgrade'}">
                            ${userLevel === 0 ? 'Y√™u c·∫ßu x√¢y d·ª±ng' : `N√¢ng c·∫•p l√™n c·∫•p ${nextLevel}`}
                        </h4>
                        
                        <div class="upgrade-cost">
                            <div class="cost-item">
                                <img src="/static/img/icon/info/gold.png" style="width: 16px; height: 16px; object-fit: contain; margin-right: 5px; vertical-align: middle;" alt="Gold">
                                <span>V√†ng c·∫ßn thi·∫øt: <strong>${upgradeInfo.gold}</strong></span>
                                <span class="user-gold">(Hi·ªán c√≥: ${userData.gold || 0})</span>
                            </div>
                `;
                
                if (upgradeInfo.materials && upgradeInfo.materials.length > 0) {
                    upgradeHtml += '<div class="materials-required"><h5>Nguy√™n li·ªáu c·∫ßn thi·∫øt:</h5>';
                    upgradeInfo.materials.forEach(material => {
                        const userItem = userData.inventory.find(item => item.item_id === material.item_id);
                        const userQuantity = userItem ? userItem.quantity : 0;
                        const hasEnough = userQuantity >= material.quantity;
                        
                        upgradeHtml += `
                            <div class="material-item ${hasEnough ? 'sufficient' : 'insufficient'}">
                                <img src="/static/img/icon/item/${material.item_id}.png" 
                                     style="width: 16px; height: 16px; object-fit: contain; margin-right: 5px;" 
                                     alt="Material"
                                     onerror="this.src='/static/img/icon/button/cube.png'">
                                <span>C·∫ßn: ${material.quantity}</span>
                                <span>(C√≥: ${userQuantity})</span>
                            </div>
                        `;
                    });
                    upgradeHtml += '</div>';
                }
                
                upgradeHtml += '</div></div>';
                
                document.getElementById('upgradeInfo').innerHTML = upgradeHtml;
                
                // Update upgrade button
                const upgradeButton = document.getElementById('upgradeButton');
                upgradeButton.textContent = userLevel === 0 ? 'X√¢y d·ª±ng' : 'N√¢ng c·∫•p';
                upgradeButton.innerHTML = `
                    <img src="/static/img/icon/button/${userLevel === 0 ? 'build' : 'up'}.png" alt="${userLevel === 0 ? 'Build' : 'Upgrade'}"> 
                    ${userLevel === 0 ? 'X√¢y d·ª±ng' : 'N√¢ng c·∫•p'}
                `;
                upgradeButton.onclick = () => upgradeBuildingConfirm(buildingId, nextLevel);
                
                // Show modal
                document.getElementById('buildingModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading building info:', error);
                showToast('L·ªói khi t·∫£i th√¥ng tin c√¥ng tr√¨nh', 'error');
            }
        }

        // Confirm building upgrade
        async function upgradeBuildingConfirm(buildingId, level) {
            try {
                const response = await apiCall('/api/upgrade-building', 'POST', {
                    building_id: buildingId,
                    level: level
                });
                
                if (response.success) {
                    showToast(response.message, 'success');
                    
                    // Update user data
                    const userData = getUserData();
                    userData.buildings[buildingId] = level;
                    userData.gold = response.new_gold;
                    userData.inventory = response.new_inventory;
                    localStorage.setItem('userData', JSON.stringify(userData));
                    
                    // Refresh buildings display
                    loadBuildings();
                    updateUserInfoDisplay(userData);
                    
                    // Close modal
                    closeModal();
                } else {
                    showToast(response.message, 'error');
                }
            } catch (error) {
                console.error('Error upgrading building:', error);
                showToast('L·ªói khi n√¢ng c·∫•p c√¥ng tr√¨nh', 'error');
            }
        }
    </script>
</body>
</html>
