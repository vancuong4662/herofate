<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th·ªã Tr·∫•n - Hero Fate</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Huninn&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/equipment.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        /* Equipment selection styling */
        .equipment-slot.selected {
            border: 3px solid #f39c12 !important;
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.8) !important;
            transform: scale(1.05);
            transition: all 0.3s ease;
            background: rgba(243, 156, 18, 0.1) !important;
        }
        
        .equipment-slot.equipped:hover {
            transform: scale(1.02);
            transition: all 0.2s ease;
            border: 2px solid rgba(46, 204, 113, 0.6);
        }
        
        .equipment-slot.equipped {
            cursor: pointer;
            border: 2px solid rgba(46, 204, 113, 0.3);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1><img src="/static/img/icon/button/town.png" style="width: 48px; height: 48x; object-fit: contain; margin-right: 10px; vertical-align: middle;" alt="Town"> Th·ªã Tr·∫•n</h1>
        </div>

        <!-- User Info & Navigation Bar -->
        <div class="game-info-nav">
            <!-- User Stats -->
            <div class="user-stats">
                <div class="info-item">
                    <img src="/static/img/icon/info/exp.png" style="width: 16px; height: 16px; object-fit: contain; margin-right: 5px; vertical-align: middle;" alt="Level">
                    <span>C·∫•p ƒë·ªô: <strong id="userLevel">1</strong></span>
                </div>
                <div class="info-item">
                    <img src="/static/img/icon/info/gold.png" style="width: 16px; height: 16px; object-fit: contain; margin-right: 5px; vertical-align: middle;" alt="Gold">
                    <span>V√†ng: <strong id="userGold">0</strong></span>
                </div>
                <div class="info-item">
                    <img src="/static/img/icon/info/exp.png" style="width: 16px; height: 16px; object-fit: contain; margin-right: 5px; vertical-align: middle;" alt="EXP">
                    <span>EXP: <strong id="userExp">0</strong></span>
                </div>
                <div class="info-item">
                    <img src="/static/img/icon/info/reputation.png" style="width: 16px; height: 16px; object-fit: contain; margin-right: 5px; vertical-align: middle;" alt="Reputation">
                    <span>Danh ti·∫øng: <strong id="userReputation">0</strong></span>
                </div>
            </div>
            
            <!-- Navigation Actions -->
            <div class="nav-actions">
                <button class="btn btn-primary btn-icon" onclick="showPlayerInfo()">
                    <img src="/static/img/icon/button/info.png" alt="Info"> Th√¥ng tin
                </button>
                <button class="btn btn-secondary btn-icon" onclick="logout()">
                    <img src="/static/img/icon/button/logout.png" alt="Logout"> ƒêƒÉng xu·∫•t
                </button>
            </div>
        </div>

        <!-- Buildings Grid -->
        <div class="buildings-grid" id="buildingsContainer">
            <!-- Buildings will be loaded by JavaScript -->
        </div>
    </div>

    <!-- Player Info Modal -->
    <div id="playerInfoModal" class="modal">
        <div class="modal-content player-info-modal">
            <!-- Modal Header -->
            <div class="modal-header">
                <h2 class="modal-title">
                    <img src="/static/img/icon/info/user.png" style="width: 20px; height: 20px; object-fit: contain; margin-right: 8px; vertical-align: middle;" alt="User"> Th√¥ng tin nh√¢n v·∫≠t
                </h2>
                <button class="modal-close" onclick="closeModal()">
                    <img src="/static/img/icon/button/close.png" style="width: 16px; height: 16px; object-fit: contain;" alt="Close">
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="modal-body">
                <div class="player-info-container">
                    <!-- Left Side - Avatar & Equipment -->
                    <div class="player-info-left">
                        <div class="player-info-avatar">
                            <canvas id="playerInfoCanvas" width="128" height="128"></canvas>
                            <div class="avatar-label">
                                <img src="/static/img/icon/info/user.png" style="width: 16px; height: 16px; object-fit: contain; margin-right: 5px; vertical-align: middle;" alt="Player">
                                <span id="playerUsername">T√™n t√†i kho·∫£n</span>
                            </div>
                        </div>
                        
                        <!-- Equipment Section -->
                        <div class="equipment-section">
                            <h4 class="section-title">
                                <img src="/static/img/icon/button/inventory.png" style="width: 16px; height: 16px; object-fit: contain; margin-right: 5px; vertical-align: middle;" alt="Equipment">
                                Trang b·ªã hi·ªán t·∫°i
                            </h4>
                            <div class="equipment-grid">
                                <div class="equipment-slot" id="equipmentSlot-helmet">
                                    <div class="slot-label">M≈©</div>
                                    <div class="slot-content" onclick="unequipItem('helmet')">
                                        <img src="/static/img/icon/item/cube.png" class="equipment-icon" alt="Empty">
                                        <span class="equipment-name">Tr·ªëng</span>
                                        <span class="equipment-level">Lv.0</span>
                                    </div>
                                </div>
                                
                                <div class="equipment-slot" id="equipmentSlot-armor">
                                    <div class="slot-label">√Åo gi√°p</div>
                                    <div class="slot-content" onclick="unequipItem('armor')">
                                        <img src="/static/img/icon/item/cube.png" class="equipment-icon" alt="Empty">
                                        <span class="equipment-name">Tr·ªëng</span>
                                        <span class="equipment-level">Lv.0</span>
                                    </div>
                                </div>
                                
                                <div class="equipment-slot" id="equipmentSlot-weapon">
                                    <div class="slot-label">V≈© kh√≠</div>
                                    <div class="slot-content" onclick="unequipItem('weapon')">
                                        <img src="/static/img/icon/item/cube.png" class="equipment-icon" alt="Empty">
                                        <span class="equipment-name">Tr·ªëng</span>
                                        <span class="equipment-level">Lv.0</span>
                                    </div>
                                </div>
                                
                                <div class="equipment-slot" id="equipmentSlot-ring">
                                    <div class="slot-label">Nh·∫´n</div>
                                    <div class="slot-content" onclick="unequipItem('ring')">
                                        <img src="/static/img/icon/item/cube.png" class="equipment-icon" alt="Empty">
                                        <span class="equipment-name">Tr·ªëng</span>
                                        <span class="equipment-level">Lv.0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Side - Stats & Info -->
                    <div class="player-info-stats">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <img src="/static/img/icon/info/exp.png" style="width: 16px; height: 16px; object-fit: contain;" alt="Level">
                                <div class="stat-content">
                                    <span class="stat-label">C·∫•p ƒë·ªô</span>
                                    <span class="stat-value" id="playerInfoLevel">1</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <img src="/static/img/icon/info/gold.png" style="width: 16px; height: 16px; object-fit: contain;" alt="Gold">
                                <div class="stat-content">
                                    <span class="stat-label">V√†ng</span>
                                    <span class="stat-value" id="playerInfoGold">0</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <img src="/static/img/icon/info/exp.png" style="width: 16px; height: 16px; object-fit: contain;" alt="EXP">
                                <div class="stat-content">
                                    <span class="stat-label">Kinh nghi·ªám</span>
                                    <span class="stat-value" id="playerInfoExp">0</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <img src="/static/img/icon/info/reputation.png" style="width: 16px; height: 16px; object-fit: contain;" alt="Reputation">
                                <div class="stat-content">
                                    <span class="stat-label">Danh ti·∫øng</span>
                                    <span class="stat-value" id="playerInfoReputation">0</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <img src="/static/img/icon/info/stat/str.png" style="width: 16px; height: 16px; object-fit: contain;" alt="STR">
                                <div class="stat-content">
                                    <span class="stat-label">S·ª©c m·∫°nh (STR)</span>
                                    <span class="stat-value" id="playerInfoSTR">10</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <img src="/static/img/icon/info/stat/agi.png" style="width: 16px; height: 16px; object-fit: contain;" alt="AGI">
                                <div class="stat-content">
                                    <span class="stat-label">Nhanh nh·∫πn (AGI)</span>
                                    <span class="stat-value" id="playerInfoAGI">10</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <img src="/static/img/icon/info/stat/int.png" style="width: 16px; height: 16px; object-fit: contain;" alt="INT">
                                <div class="stat-content">
                                    <span class="stat-label">Tr√≠ tu·ªá (INT)</span>
                                    <span class="stat-value" id="playerInfoINT">10</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <img src="/static/img/icon/info/stat/vit.png" style="width: 16px; height: 16px; object-fit: contain;" alt="VIT">
                                <div class="stat-content">
                                    <span class="stat-label">Th·ªÉ l·ª±c (VIT)</span>
                                    <span class="stat-value" id="playerInfoVIT">10</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <img src="/static/img/icon/info/stat/wis.png" style="width: 16px; height: 16px; object-fit: contain;" alt="WIS">
                                <div class="stat-content">
                                    <span class="stat-label">Kh√¥n ngoan (WIS)</span>
                                    <span class="stat-value" id="playerInfoWIS">10</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <img src="/static/img/icon/info/stat/str.png" style="width: 16px; height: 16px; object-fit: contain;" alt="Crit">
                                <div class="stat-content">
                                    <span class="stat-label">T·ª∑ l·ªá ch√≠ m·∫°ng</span>
                                    <span class="stat-value" id="playerInfoCrit">10%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="modal-footer">
                <button id="unequipButton" class="btn btn-warning btn-icon" style="display: none;" onclick="unequipSelectedItem()">
                    <img src="/static/img/icon/button/unequip.png" alt="Unequip"> Th√°o
                </button>
                <button class="btn btn-secondary btn-icon" onclick="closeModal()">
                    <img src="/static/img/icon/button/cancel.png" alt="Close"> ƒê√≥ng
                </button>
            </div>
        </div>
    </div>

    <!-- Building Modal -->
    <div id="buildingModal" class="modal">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h2 class="modal-title" id="modalBuildingName">T√™n c√¥ng tr√¨nh</h2>
                <button class="modal-close" onclick="closeModal()">
                    <img src="/static/img/icon/button/close.png" style="width: 16px; height: 16px; object-fit: contain;" alt="Close">
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="modal-body">
                <p id="modalBuildingDescription">M√¥ t·∫£ c√¥ng tr√¨nh</p>
                
                <div id="upgradeInfo">
                    <!-- Upgrade information will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="modal-footer">
                <button id="upgradeButton" class="btn btn-primary btn-icon">
                    <img src="/static/img/icon/button/build.png" alt="Build"> X√¢y d·ª±ng
                </button>
                <button class="btn btn-secondary btn-icon" onclick="closeModal()">
                    <img src="/static/img/icon/button/cancel.png" alt="Close"> ƒê√≥ng
                </button>
            </div>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div id="inventoryModal" class="modal inventory-modal">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h2 class="modal-title">
                    <img src="/static/img/icon/button/inventory.png" style="width: 20px; height: 20px; object-fit: contain; margin-right: 8px; vertical-align: middle;" alt="Inventory"> Kho ƒë·ªì
                </h2>
                <button class="modal-close" onclick="closeModal()">
                    <img src="/static/img/icon/button/close.png" style="width: 16px; height: 16px; object-fit: contain;" alt="Close">
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="modal-body">
                <div class="inventory-container">
                    <!-- Main Inventory Panel (70%) -->
                    <div class="inventory-main">
                        <div class="inventory-tabs">
                            <button class="btn btn-primary btn-icon" onclick="showInventoryTab('equipment')">
                                <img src="/static/img/icon/button/blacksmith.png" alt="Equipment"> Trang b·ªã
                            </button>
                            <button class="btn btn-primary btn-icon" onclick="showInventoryTab('material')">
                                <img src="/static/img/icon/button/market.png" alt="Material"> Nguy√™n li·ªáu
                            </button>
                        </div>
                        
                        <div class="inventory-grid" id="inventoryGrid">
                            <!-- Inventory slots will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Item Detail Sidebar (30%) -->
                    <div class="inventory-sidebar">
                        <div class="item-detail empty" id="itemDetail">
                            <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">
                                <img src="/static/img/icon/info/user.png" style="width: 32px; height: 32px; object-fit: contain; margin-bottom: 10px; opacity: 0.5;" alt="Select Item">
                                <p>Di chu·ªôt qua item ƒë·ªÉ xem chi ti·∫øt</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="modal-footer">
                <button id="useItemButton" class="btn btn-primary btn-icon" style="display: none;" onclick="useSelectedItem()">
                    <img src="/static/img/icon/button/start.png" alt="Use"> S·ª≠ d·ª•ng
                </button>
                <button class="btn btn-secondary btn-icon" onclick="closeModal()">
                    <img src="/static/img/icon/button/cancel.png" alt="Close"> ƒê√≥ng
                </button>
            </div>
        </div>
    </div>

    <script src="/static/js/support.js"></script>
    <script src="/static/js/gml.js"></script>
    <script src="/static/js/main.js"></script>
    <script>
        // Player Animation Configuration
        const ANIMATION_CONFIG = {
            FRAME_SPEED: 0.1,        // T·ªëc ƒë·ªô chuy·ªÉn frame (0.05 = ch·∫≠m, 0.3 = nhanh)
            FRAME_COUNT: 4,          // S·ªë frame trong sprite
            CANVAS_SIZE: 128,        // K√≠ch th∆∞·ªõc canvas
            SPRITE_SIZE: 128,        // K√≠ch th∆∞·ªõc m·ªói frame sprite
            AUTO_START: false        // T·ª± ƒë·ªông b·∫Øt ƒë·∫ßu animation khi load page
        };

        // Player Animation System
        let playerSprite = null;
        let playerInstance = null;
        let playerCanvas = null;
        let playerCtx = null;
        let animationRunning = false;

        function initPlayerAnimation() {
            playerCanvas = document.getElementById('playerInfoCanvas');
            if (!playerCanvas) {
                console.error('Player canvas not found');
                return;
            }
            
            playerCtx = playerCanvas.getContext('2d');
            
            // Create player sprite with configurable parameters
            playerSprite = spriteCreate(
                '/static/img/player/male_idle.png', 
                ANIMATION_CONFIG.SPRITE_SIZE, 
                ANIMATION_CONFIG.SPRITE_SIZE, 
                ANIMATION_CONFIG.FRAME_COUNT, 
                ANIMATION_CONFIG.SPRITE_SIZE / 2, 
                ANIMATION_CONFIG.SPRITE_SIZE / 2
            );
            
            // Wait for image to load
            playerSprite.image.onload = function() {
                // Create player instance with configurable speed
                playerInstance = instCreate(
                    ANIMATION_CONFIG.CANVAS_SIZE / 2, 
                    ANIMATION_CONFIG.CANVAS_SIZE / 2, 
                    0, 
                    playerSprite
                );
                playerInstance.imageSpeed = ANIMATION_CONFIG.FRAME_SPEED;
                playerInstance.imageLoop = true;
                
                // Auto start if configured
                if (ANIMATION_CONFIG.AUTO_START) {
                    startPlayerAnimation();
                }
            };
            
            playerSprite.image.onerror = function() {
                console.error('Failed to load player sprite');
                drawFallbackPlayer();
            };
        }

        function startPlayerAnimation() {
            if (animationRunning) return;
            animationRunning = true;
            
            function animate() {
                if (!animationRunning || !playerInstance || !playerCanvas) return;
                
                // Clear canvas
                playerCtx.clearRect(0, 0, playerCanvas.width, playerCanvas.height);
                
                // Update animation frame using configurable speed
                playerInstance.imageFrameCounter += playerInstance.imageSpeed;
                if (playerInstance.imageFrameCounter >= 1) {
                    playerInstance.imageIndex = (playerInstance.imageIndex + 1) % ANIMATION_CONFIG.FRAME_COUNT;
                    playerInstance.imageFrameCounter = 0;
                }
                
                // Draw player sprite at full size (128x128)
                drawPlayerFrame();
                
                // Continue animation
                requestAnimationFrame(animate);
            }
            
            animate();
        }

        function drawPlayerFrame() {
            if (!playerSprite || !playerInstance) return;
            
            const frameX = (playerInstance.imageIndex % ANIMATION_CONFIG.FRAME_COUNT) * ANIMATION_CONFIG.SPRITE_SIZE;
            const frameY = 0; // Single row of frames
            
            // Draw at configured canvas size
            const drawWidth = ANIMATION_CONFIG.SPRITE_SIZE;
            const drawHeight = ANIMATION_CONFIG.SPRITE_SIZE;
            const drawX = (ANIMATION_CONFIG.CANVAS_SIZE - drawWidth) / 2;
            const drawY = (ANIMATION_CONFIG.CANVAS_SIZE - drawHeight) / 2;
            
            playerCtx.drawImage(
                playerSprite.image,
                frameX, frameY, ANIMATION_CONFIG.SPRITE_SIZE, ANIMATION_CONFIG.SPRITE_SIZE,
                drawX, drawY, drawWidth, drawHeight
            );
        }

        function drawFallbackPlayer() {
            if (!playerCtx) return;
            playerCtx.fillStyle = '#3498db';
            playerCtx.fillRect(0, 0, ANIMATION_CONFIG.CANVAS_SIZE, ANIMATION_CONFIG.CANVAS_SIZE);
            playerCtx.fillStyle = 'white';
            playerCtx.font = '40px Arial';
            playerCtx.textAlign = 'center';
            playerCtx.fillText('üë§', ANIMATION_CONFIG.CANVAS_SIZE/2, ANIMATION_CONFIG.CANVAS_SIZE/2 + 15);
        }

        // Animation Control Functions
        /**
         * ƒêi·ªÅu ch·ªânh t·ªëc ƒë·ªô animation c·ªßa avatar
         * @param {number} speed - T·ªëc ƒë·ªô (0.05 = r·∫•t ch·∫≠m, 0.15 = b√¨nh th∆∞·ªùng, 0.3 = r·∫•t nhanh)
         * V√≠ d·ª•: setAnimationSpeed(0.1); // ƒê·∫∑t t·ªëc ƒë·ªô ch·∫≠m
         */
        function setAnimationSpeed(speed) {
            ANIMATION_CONFIG.FRAME_SPEED = speed;
            if (playerInstance) {
                playerInstance.imageSpeed = speed;
            }
        }

        /**
         * L·∫•y t·ªëc ƒë·ªô animation hi·ªán t·∫°i
         * @returns {number} T·ªëc ƒë·ªô hi·ªán t·∫°i
         */
        function getAnimationSpeed() {
            return ANIMATION_CONFIG.FRAME_SPEED;
        }

        /**
         * S·ª≠ d·ª•ng preset t·ªëc ƒë·ªô animation c√≥ s·∫µn
         * @param {string} preset - Preset: 'very_slow', 'slow', 'normal', 'fast', 'very_fast'
         * V√≠ d·ª•: setAnimationPreset('slow'); // ƒê·∫∑t t·ªëc ƒë·ªô ch·∫≠m
         */
        // Preset animation speeds
        function setAnimationPreset(preset) {
            const presets = {
                'very_slow': 0.05,
                'slow': 0.1,
                'normal': 0.15,
                'fast': 0.2,
                'very_fast': 0.3
            };
            
            if (presets[preset]) {
                setAnimationSpeed(presets[preset]);
            } else {
                console.error(`Unknown preset: ${preset}. Available: very_slow, slow, normal, fast, very_fast`);
            }
        }

        /*
         * H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG ANIMATION SYSTEM:
         * 
         * 1. Thay ƒë·ªïi t·ªëc ƒë·ªô animation:
         *    setAnimationSpeed(0.1);  // T·ªëc ƒë·ªô ch·∫≠m
         *    setAnimationSpeed(0.15); // T·ªëc ƒë·ªô b√¨nh th∆∞·ªùng
         *    setAnimationSpeed(0.2);  // T·ªëc ƒë·ªô nhanh
         * 
         * 2. S·ª≠ d·ª•ng preset c√≥ s·∫µn:
         *    setAnimationPreset('slow');    // Ch·∫≠m
         *    setAnimationPreset('normal');  // B√¨nh th∆∞·ªùng
         *    setAnimationPreset('fast');    // Nhanh
         * 
         * 3. Ki·ªÉm tra t·ªëc ƒë·ªô hi·ªán t·∫°i:
         *    console.log(getAnimationSpeed());
         * 
         * 4. D·ª´ng/kh·ªüi ƒë·ªông animation:
         *    stopPlayerAnimation();   // D·ª´ng
         *    startPlayerAnimation();  // Kh·ªüi ƒë·ªông
         */

        function stopPlayerAnimation() {
            animationRunning = false;
        }

        // Player Info Modal functions
        async function showPlayerInfo() {
            const modal = document.getElementById('playerInfoModal');
            const userData = getUserData();
            
            if (!userData) {
                showToast('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin ng∆∞·ªùi ch∆°i', 'error');
                return;
            }
            
            // Reset equipment selection
            selectedEquipmentSlot = null;
            updateUnequipButton();
            
            // Update player info in modal
            document.getElementById('playerUsername').textContent = userData.username;
            document.getElementById('playerInfoLevel').textContent = Math.floor(userData.exp / 100) + 1;
            document.getElementById('playerInfoGold').textContent = userData.gold || 0;
            document.getElementById('playerInfoExp').textContent = userData.exp || 0;
            document.getElementById('playerInfoReputation').textContent = userData.reputation || 0;
            
            // Load equipment data
            try {
                const equipmentResponse = await apiCall('/api/equipment');
                if (equipmentResponse.success) {
                    await updateEquipmentDisplay(equipmentResponse);
                    await updateStatsWithEquipment(userData, equipmentResponse);
                } else {
                    console.error('Error loading equipment:', equipmentResponse.message);
                    // Still show modal with base stats
                    updateStatsDisplay(userData.stats || {});
                }
            } catch (error) {
                console.error('Error loading equipment:', error);
                updateStatsDisplay(userData.stats || {});
            }
            
            // Show modal
            modal.style.display = 'block';
            
            // Add instruction tooltip for equipment slots
            setTimeout(() => {
                const equippedSlots = document.querySelectorAll('.equipment-slot.equipped');
                equippedSlots.forEach(slot => {
                    if (!slot.title.includes('Click ƒë·ªÉ ch·ªçn')) {
                        slot.title = 'Click ƒë·ªÉ ch·ªçn trang b·ªã';
                    }
                });
            }, 100);
            
            // Start player animation
            if (!animationRunning) {
                startPlayerAnimation();
            }
        }

        async function updateEquipmentDisplay(equipmentData) {
            const slots = ['helmet', 'armor', 'weapon', 'ring'];
            
            slots.forEach(slot => {
                const slotElement = document.getElementById(`equipmentSlot-${slot}`);
                const equipment = equipmentData.equipment[slot];
                const equippedItem = equipmentData.equipped_items[slot];
                
                if (equipment && equippedItem) {
                    // Item is equipped
                    slotElement.classList.add('equipped');
                    slotElement.style.cursor = 'pointer';
                    slotElement.title = 'Click ƒë·ªÉ ch·ªçn trang b·ªã';
                    
                    // Add click handler for selection
                    slotElement.onclick = () => {
                        console.log('Equipment slot clicked:', slot);
                        selectEquipmentSlot(slot);
                    };
                    
                    console.log(`Equipment slot ${slot} set up with click handler`);
                    
                    const icon = slotElement.querySelector('.equipment-icon');
                    const name = slotElement.querySelector('.equipment-name');
                    const level = slotElement.querySelector('.equipment-level');
                    
                    icon.src = `/static/img/icon/item/${equippedItem.item_id}.png`;
                    icon.onerror = () => { icon.src = '/static/img/icon/item/cube.png'; };
                    name.textContent = equippedItem.name;
                    
                    // Show level as stars if level > 0
                    if (equipment.level > 0) {
                        let levelHtml = '';
                        for (let i = 0; i < Math.min(equipment.level, 3); i++) {
                            levelHtml += '‚≠ê';
                        }
                        if (equipment.level > 3) {
                            levelHtml += `+${equipment.level - 3}`;
                        }
                        level.innerHTML = levelHtml;
                    } else {
                        level.textContent = 'Lv.0';
                    }
                } else {
                    // Slot is empty
                    slotElement.classList.remove('equipped');
                    slotElement.style.cursor = 'default';
                    slotElement.title = '';
                    slotElement.onclick = null;
                    
                    const icon = slotElement.querySelector('.equipment-icon');
                    const name = slotElement.querySelector('.equipment-name');
                    const level = slotElement.querySelector('.equipment-level');
                    
                    icon.src = '/static/img/icon/item/cube.png';
                    name.textContent = 'Tr·ªëng';
                    level.textContent = 'Lv.0';
                }
                
                // Remove any existing selection styling
                slotElement.classList.remove('selected');
            });
            
            // Update unequip button visibility
            updateUnequipButton();
        }

        // Equipment selection functions for player info modal
        function selectEquipmentSlot(slot) {
            console.log('Selecting equipment slot:', slot);
            
            // Remove previous selection
            document.querySelectorAll('.equipment-slot.selected').forEach(slotElement => {
                slotElement.classList.remove('selected');
            });
            
            // Add selection to clicked slot
            const slotElement = document.getElementById(`equipmentSlot-${slot}`);
            console.log('Slot element:', slotElement);
            console.log('Has equipped class:', slotElement ? slotElement.classList.contains('equipped') : 'no element');
            
            if (slotElement && slotElement.classList.contains('equipped')) {
                slotElement.classList.add('selected');
                selectedEquipmentSlot = slot;
                slotElement.title = 'ƒê√£ ch·ªçn - Click n√∫t Th√°o ƒë·ªÉ g·ª° trang b·ªã';
                console.log('Equipment slot selected successfully:', slot);
            } else {
                selectedEquipmentSlot = null;
                console.log('Cannot select slot - not equipped or element not found');
            }
            
            // Update unequip button visibility
            updateUnequipButton();
        }
        
        function updateUnequipButton() {
            const unequipButton = document.getElementById('unequipButton');
            if (unequipButton) {
                if (selectedEquipmentSlot) {
                    unequipButton.style.display = 'inline-flex';
                } else {
                    unequipButton.style.display = 'none';
                }
            }
        }
        
        async function unequipSelectedItem() {
            if (!selectedEquipmentSlot) {
                showToast('Ch∆∞a ch·ªçn trang b·ªã n√†o', 'error');
                return;
            }
            
            await unequipItem(selectedEquipmentSlot);
            
            // Reset selection after unequip
            selectedEquipmentSlot = null;
            updateUnequipButton();
        }

        // Function to unequip item
        async function unequipItem(slot) {
            const userData = getUserData();
            const equipment = userData.equipment || {};
            
            // Check if there's an item equipped in this slot
            if (!equipment[slot]) {
                showToast('Kh√¥ng c√≥ trang b·ªã n√†o trong slot n√†y', 'info');
                return;
            }
            
            try {
                const response = await apiCall('/api/equipment/unequip', 'POST', {
                    slot: slot
                });
                
                if (response.success) {
                    showToast(response.message, 'success');
                    
                    // Update user data
                    userData.equipment = response.equipment;
                    userData.inventory = response.inventory;
                    updateUserData(userData);
                    
                    // Update user info display in header
                    updateUserInfoDisplay(userData);
                    
                    // Check if player info modal is open
                    const playerInfoModalOpen = document.getElementById('playerInfoModal').style.display === 'block';
                    
                    if (playerInfoModalOpen) {
                        // Refresh equipment display in current modal
                        try {
                            const equipmentResponse = await apiCall('/api/equipment');
                            if (equipmentResponse.success) {
                                await updateEquipmentDisplay(equipmentResponse);
                                await updateStatsWithEquipment(userData, equipmentResponse);
                            }
                        } catch (error) {
                            console.error('Error refreshing equipment display:', error);
                        }
                    } else {
                        // Original behavior - close player info modal and open inventory
                        document.getElementById('playerInfoModal').style.display = 'none';
                        
                        // Stop player animation
                        if (animationRunning) {
                            stopPlayerAnimation();
                        }
                        
                        // Open inventory modal with equipment tab to show the unequipped item
                        setTimeout(async () => {
                            const modal = document.getElementById('inventoryModal');
                            modal.style.display = 'block';
                            
                            // Reset selection state first
                            selectedItem = null;
                            document.querySelectorAll('.inventory-slot.selected').forEach(slot => {
                                slot.classList.remove('selected');
                            });
                            
                            // Fetch fresh inventory data from server
                            try {
                                const userData = getUserData();
                                const freshResponse = await fetch('/api/user/inventory', {
                                    method: 'GET',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-Username': userData.username
                                    }
                                });
                                const freshData = await freshResponse.json();
                                
                                if (freshData.success) {
                                    // Update local storage with fresh inventory data
                                    const currentUserData = getUserData();
                                    currentUserData.inventory = freshData.inventory;
                                    updateUserData(currentUserData);
                                }
                            } catch (error) {
                                console.error('Error fetching fresh inventory:', error);
                            }
                            
                            await showInventoryTab('equipment');
                        }, 200); // Small delay for smooth transition
                    }
                    
                } else {
                    showToast(response.message, 'error');
                }
            } catch (error) {
                console.error('Error unequipping item:', error);
                showToast('L·ªói khi g·ª° trang b·ªã', 'error');
            }
        }

        async function updateStatsWithEquipment(userData, equipmentData) {
            const baseStats = userData.stats || {};
            const equipmentStats = equipmentData.total_stats || {};
            
            // Calculate final stats (base + equipment)
            const finalStats = {
                STR: (baseStats.STR || 10) + (equipmentStats.STR || 0),
                AGI: (baseStats.AGI || 10) + (equipmentStats.AGI || 0),
                INT: (baseStats.INT || 10) + (equipmentStats.INT || 0),
                VIT: (baseStats.VIT || 10) + (equipmentStats.VIT || 0),
                WIS: (baseStats.WIS || 10) + (equipmentStats.WIS || 0),
                crit_rate: (baseStats.crit_rate || 0.05) + (equipmentStats.crit_rate || 0)
            };
            
            updateStatsDisplay(finalStats, baseStats, equipmentStats);
        }

        function updateStatsDisplay(finalStats, baseStats = null, equipmentStats = null) {
            document.getElementById('playerInfoSTR').innerHTML = formatStatValue('STR', finalStats.STR, baseStats, equipmentStats);
            document.getElementById('playerInfoAGI').innerHTML = formatStatValue('AGI', finalStats.AGI, baseStats, equipmentStats);
            document.getElementById('playerInfoINT').innerHTML = formatStatValue('INT', finalStats.INT, baseStats, equipmentStats);
            document.getElementById('playerInfoVIT').innerHTML = formatStatValue('VIT', finalStats.VIT, baseStats, equipmentStats);
            document.getElementById('playerInfoWIS').innerHTML = formatStatValue('WIS', finalStats.WIS, baseStats, equipmentStats);
            
            const critPercent = Math.round((finalStats.crit_rate || 0.05) * 100);
            document.getElementById('playerInfoCrit').innerHTML = formatStatValue('crit_rate', critPercent + '%', baseStats, equipmentStats);
        }

        function formatStatValue(statKey, finalValue, baseStats, equipmentStats) {
            if (!baseStats || !equipmentStats) {
                return finalValue;
            }
            
            const baseValue = baseStats[statKey] || (statKey === 'crit_rate' ? 0.05 : 10);
            const equipValue = equipmentStats[statKey] || 0;
            
            if (equipValue > 0) {
                if (statKey === 'crit_rate') {
                    const baseCrit = Math.round(baseValue * 100);
                    const equipCrit = Math.round(equipValue * 100);
                    return `${baseCrit + equipCrit}% <span style="color: #27ae60;">(+${equipCrit}%)</span>`;
                } else {
                    return `${finalValue} <span style="color: #27ae60;">(+${equipValue})</span>`;
                }
            }
            
            return finalValue;
        }

        // Close modal function (enhanced)
        function closeModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.style.display = 'none';
            });
            
            // Stop player animation when modal closes
            if (animationRunning) {
                stopPlayerAnimation();
            }
            
            // Reset equipment selection when closing player info modal
            const playerInfoModal = document.getElementById('playerInfoModal');
            if (playerInfoModal.style.display === 'none') {
                selectedEquipmentSlot = null;
                document.querySelectorAll('.equipment-slot.selected').forEach(slot => {
                    slot.classList.remove('selected');
                });
                updateUnequipButton();
            }
            
            // Reset inventory selection when closing inventory modal
            const inventoryModal = document.getElementById('inventoryModal');
            if (inventoryModal.style.display === 'none') {
                selectedItem = null;
                // Remove selection styling
                document.querySelectorAll('.inventory-slot.selected').forEach(slot => {
                    slot.classList.remove('selected');
                });
                // Clear inventory grid content when closing
                const grid = document.getElementById('inventoryGrid');
                if (grid) {
                    grid.innerHTML = '';
                }
            }
        }

        // Initialize player animation system when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize sprite but don't start animation yet
            setTimeout(initPlayerAnimation, 100);
        });

        // Inventory functions
        let selectedItem = null;
        let currentTab = 'material';
        
        // Equipment selection in player info modal
        let selectedEquipmentSlot = null;
        
        // Equipment level multiplier data (loaded from API)
        let equipmentMultipliers = {
            "0": 1.0,
            "1": 1.0,
            "2": 1.2,
            "3": 1.5,
            "4": 1.8,
            "5": 2.2,
            "6": 2.7,
            "7": 3.3,
            "8": 4.0,
            "9": 4.8,
            "10": 5.7
        };
        
        // Load equipment configuration from API
        async function loadEquipmentConfig() {
            try {
                const response = await apiCall('/api/equipment');
                if (response.success && response.equipment_config) {
                    equipmentMultipliers = {
                        "0": 1.0,
                        ...response.equipment_config.level_multipliers
                    };
                }
            } catch (error) {
                console.warn('Could not load equipment config, using defaults');
            }
        }
        
        // Get level multiplier for equipment upgrades
        function getLevelMultiplier(level) {
            return equipmentMultipliers[level.toString()] || 1.0;
        }
        
        async function showInventory() {
            const userData = getUserData();
            if (!userData || !userData.username) {
                showToast('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin ng∆∞·ªùi ch∆°i', 'error');
                return;
            }
            
            // Reset selection state
            selectedItem = null;
            document.querySelectorAll('.inventory-slot.selected').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            // Clear any existing modal content first
            const modal = document.getElementById('inventoryModal');
            const grid = document.getElementById('inventoryGrid');
            
            // Force hide modal and completely clear all content
            modal.style.display = 'none';
            grid.innerHTML = '';
            
            // Clear any cached DOM elements
            const itemDetail = document.getElementById('itemDetail');
            if (itemDetail) {
                itemDetail.innerHTML = '';
            }
            
            try {
                const response = await fetch('/api/user/inventory', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Username': userData.username
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update local storage with fresh inventory data
                    const currentUserData = getUserData(); // Get fresh copy
                    currentUserData.inventory = data.inventory;
                    updateUserData(currentUserData);
                    
                    // Force clear the grid one more time
                    grid.innerHTML = '';
                    
                    // Small delay to ensure DOM is ready
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    // Only now show the modal with fresh data
                    modal.style.display = 'block';
                    
                    // Show default tab with fresh data
                    await showInventoryTab('material');
                } else {
                    console.error('Error fetching inventory:', data.message);
                    showToast(`L·ªói t·∫£i d·ªØ li·ªáu: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Error fetching inventory:', error);
                showToast('Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server', 'error');
            }
        }

        function getItemTypeVietnamese(type) {
            const typeMap = {
                'material': 'Nguy√™n li·ªáu',
                'equipment': 'Trang b·ªã',
                'consumable': 'V·∫≠t ph·∫©m ti√™u hao',
                'weapon': 'V≈© kh√≠',
                'armor': 'Gi√°p',
                'accessory': 'Ph·ª• ki·ªán'
            };
            return typeMap[type] || type;
        }

        function getItemIcon(itemData) {
            // Return path to png icon image
            return `/static/img/icon/item/${itemData.item_id}.png`;
        }

        function getItemIconFallback(itemData) {
            // Fallback font awesome icons if image fails to load
            if (itemData.type === 'equipment') {
                return 'fas fa-sword';
            } else if (itemData.type === 'material') {
                const materialIcons = {
                    'wood': 'fas fa-tree',
                    'stone': 'fas fa-mountain',
                    'iron': 'fas fa-hammer',
                    'coal': 'fas fa-fire',
                    'herb': 'fas fa-leaf',
                    'crystal': 'fas fa-gem',
                    'mana_stone': 'fas fa-star',
                    'diamond': 'fas fa-diamond'
                };
                return materialIcons[itemData.item_id] || 'fas fa-cube';
            }
            return 'fas fa-question';
        }

        async function showInventoryTab(type) {
            currentTab = type;
            
            // Always get fresh data from localStorage
            const userData = getUserData();
            const inventory = userData.inventory || [];
            const grid = document.getElementById('inventoryGrid');
            
            // Force clear grid content first
            grid.innerHTML = '';
            
            // Show loading while processing
            grid.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1 / -1;"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...</p>';
            
            // Reset selected item
            selectedItem = null;
            updateItemDetail(null);
            updateUseButton();
            
            // Load equipment config if showing equipment tab
            if (type === 'equipment') {
                await loadEquipmentConfig();
            }
            
            try {
                // Load items data to get proper names and info
                const response = await apiCall('/api/items');
                const allItems = response.items;
                
                // Create 36 slots (6x6 grid)
                const totalSlots = 36;
                let html = '';
                
                // Filter items by type
                const filteredItems = inventory.filter(item => {
                    const itemData = allItems.find(i => i.item_id === item.item_id);
                    return itemData && itemData.type === type;
                });
                
                // Fill slots
                for (let i = 0; i < totalSlots; i++) {
                    const item = filteredItems[i];
                    
                    if (item) {
                        const itemData = allItems.find(i => i.item_id === item.item_id);
                        if (itemData) {
                            const iconPath = getItemIcon(itemData);
                            const fallbackIcon = getItemIconFallback(itemData);
                            
                            // Add level indicator for equipment items
                            let levelIndicator = '';
                            if (itemData.type === 'equipment') {
                                // For equipment items, check if this item is equipped and get its level
                                // First try to get level from the item itself (if it has one)
                                let currentLevel = item.level || 0;
                                
                                // If no level in item, try to get from equipped equipment
                                if (currentLevel === 0) {
                                    const equipmentSlot = itemData.equipment_slot;
                                    const equipmentData = userData.equipment && userData.equipment[equipmentSlot];
                                    if (equipmentData && equipmentData.item_id === item.item_id) {
                                        currentLevel = equipmentData.level || 0;
                                    }
                                }
                                
                                if (currentLevel > 0) {
                                    levelIndicator = `<div class="item-level-stars">`;
                                    // Show compact level display with star icon and number
                                    levelIndicator += `<span style="font-size: 9px; color: #fff; font-weight: bold; text-shadow: 0 0 2px rgba(0,0,0,0.9);">${currentLevel}</span>`;
                                    levelIndicator += `<img src="/static/img/icon/info/star.png" style="width: 10px; height: 10px; margin-right: 1px;" alt="‚òÖ">`;
                                    levelIndicator += '</div>';
                                }
                            }
                            
                            html += `
                                <div class="inventory-slot" 
                                     data-item-id="${item.item_id}" 
                                     onmouseenter="showItemTooltip('${item.item_id}')" 
                                     onmouseleave="hideItemTooltip()"
                                     onclick="selectItem('${item.item_id}')">
                                    <img class="item-icon" 
                                         src="${iconPath}" 
                                         alt="${itemData.name}"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                                    <i class="item-icon fallback ${fallbackIcon}" style="display: none;"></i>
                                    <div class="item-quantity">${item.quantity}</div>
                                    ${levelIndicator}
                                </div>
                            `;
                        }
                    } else {
                        html += '<div class="inventory-slot empty"></div>';
                    }
                }
                
                grid.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading items:', error);
                grid.innerHTML = '<p style="text-align: center; color: #e74c3c; grid-column: 1 / -1;">L·ªói t·∫£i d·ªØ li·ªáu item.</p>';
            }
        }

        async function showItemTooltip(itemId, isSelected = false) {
            try {
                const response = await apiCall('/api/items');
                const allItems = response.items;
                const itemData = allItems.find(i => i.item_id === itemId);
                
                if (itemData) {
                    updateItemDetail(itemData, isSelected ? itemId : null);
                }
            } catch (error) {
                console.error('Error loading item tooltip:', error);
            }
        }

        function hideItemTooltip() {
            if (!selectedItem) {
                updateItemDetail(null);
            }
        }

        async function selectItem(itemId) {
            // Remove previous selection
            document.querySelectorAll('.inventory-slot.selected').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            // Add selection to clicked slot
            const slot = document.querySelector(`[data-item-id="${itemId}"]`);
            if (slot) {
                slot.classList.add('selected');
                selectedItem = itemId;
                
                // Show item detail with selected item context
                await showItemTooltip(itemId, true);
                updateUseButton();
            }
        }

        function updateItemDetail(itemData, selectedItemId = null) {
            const detailContainer = document.getElementById('itemDetail');
            
            if (!itemData) {
                detailContainer.className = 'item-detail empty';
                detailContainer.innerHTML = `
                    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">
                        <i class="fas fa-mouse-pointer" style="font-size: 2em; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>Di chu·ªôt qua item ƒë·ªÉ xem chi ti·∫øt</p>
                    </div>
                `;
                return;
            }
            
            detailContainer.className = 'item-detail';
            
            // Build level display for equipment items
            let levelHtml = '';
            let statsHtml = '';
            
            if (itemData.type === 'equipment') {
                // Get equipment level - priority: selected item > equipped item
                const userData = getUserData();
                let currentLevel = 0;
                
                if (selectedItemId) {
                    // If item is selected, try to get level from inventory item or equipped equipment
                    const inventory = userData.inventory || [];
                    const inventoryItem = inventory.find(item => item.item_id === selectedItemId);
                    if (inventoryItem && inventoryItem.level !== undefined) {
                        currentLevel = inventoryItem.level;
                    } else {
                        // Check if it's equipped
                        const equipmentSlot = itemData.equipment_slot;
                        const equipmentData = userData.equipment && userData.equipment[equipmentSlot];
                        if (equipmentData && equipmentData.item_id === selectedItemId) {
                            currentLevel = equipmentData.level || 0;
                        }
                    }
                } else {
                    // If just hovering, check equipped equipment
                    const equipmentSlot = itemData.equipment_slot;
                    const equipmentData = userData.equipment && userData.equipment[equipmentSlot];
                    if (equipmentData && equipmentData.item_id === itemData.item_id) {
                        currentLevel = equipmentData.level || 0;
                    }
                }
                
                // Generate star display for level
                if (currentLevel > 0) {
                    levelHtml = '<div class="item-level">';
                    levelHtml += '<span class="level-label">C·∫•p ƒë·ªô: </span>';
                    // Show actual stars for visual appeal
                    for (let i = 0; i < currentLevel; i++) {
                        levelHtml += '<img src="/static/img/icon/info/star.png" style="width: 12px; height: 12px; margin-right: 2px;" alt="‚òÖ">';
                    }
                    levelHtml += ` <span class="level-number">(${currentLevel})</span>`;
                    levelHtml += '</div>';
                }
                
                // Build stats display with level multipliers
                if (itemData.stat && Object.keys(itemData.stat).length > 0) {
                    statsHtml = '<div class="item-stats">';
                    
                    // Get level multiplier
                    const levelMultiplier = getLevelMultiplier(currentLevel);
                    
                    Object.entries(itemData.stat).forEach(([key, value]) => {
                        let statName = key;
                        let statValue = value;
                        let displayValue = value;
                        
                        // Apply level multiplier if equipment is upgraded
                        if (currentLevel > 0) {
                            displayValue = Math.round(value * levelMultiplier);
                        }
                        
                        // Format special stats
                        if (key === 'crit_rate') {
                            statName = 'T·ª∑ l·ªá ch√≠ m·∫°ng';
                            const basePercent = Math.round(value * 100);
                            const upgradePercent = Math.round(displayValue * 100);
                            displayValue = upgradePercent + '%';
                            
                            // Show upgrade bonus if level > 0
                            if (currentLevel > 0 && upgradePercent > basePercent) {
                                displayValue += ` <span style="color: #27ae60;">(+${upgradePercent - basePercent}%)</span>`;
                            }
                        } else {
                            // Show upgrade bonus if level > 0
                            if (currentLevel > 0 && displayValue > value) {
                                displayValue = `${displayValue} <span style="color: #27ae60;">(+${displayValue - value})</span>`;
                            } else {
                                displayValue = '+' + displayValue;
                            }
                        }
                        
                        statsHtml += `<div class="stat-item"><span>${statName}:</span><span>${displayValue}</span></div>`;
                    });
                    statsHtml += '</div>';
                }
            } else {
                // Non-equipment items - show base stats
                if (itemData.stat && Object.keys(itemData.stat).length > 0) {
                    statsHtml = '<div class="item-stats">';
                    Object.entries(itemData.stat).forEach(([key, value]) => {
                        let statName = key;
                        let statValue = value;
                        
                        // Format special stats
                        if (key === 'crit_rate') {
                            statName = 'T·ª∑ l·ªá ch√≠ m·∫°ng';
                            statValue = Math.round(value * 100) + '%';
                        } else {
                            statValue = '+' + value;
                        }
                        
                        statsHtml += `<div class="stat-item"><span>${statName}:</span><span>${statValue}</span></div>`;
                    });
                    statsHtml += '</div>';
                }
            }
            
            // Build level requirement if available
            const levelReq = itemData.level_require ? `<div class="item-level-req">Y√™u c·∫ßu: C·∫•p ${itemData.level_require}</div>` : '';
            
            // Build item image with fallback
            const iconPath = getItemIcon(itemData);
            const fallbackIcon = getItemIconFallback(itemData);
            
            detailContainer.innerHTML = `
                <div class="item-image">
                    <img src="${iconPath}" 
                         alt="${itemData.name}"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                    <i class="${fallbackIcon}" style="display: none;"></i>
                </div>
                <div class="item-name">${itemData.name}</div>
                <div class="item-type">${getItemTypeVietnamese(itemData.type)}</div>
                <div class="item-price"><i class="fas fa-coins"></i> ${itemData.price} v√†ng</div>
                ${levelReq}
                ${levelHtml}
                <div class="item-description">${itemData.description}</div>
                ${statsHtml}
            `;
        }

        function updateUseButton() {
            const useButton = document.getElementById('useItemButton');
            
            if (selectedItem) {
                // Check if selected item is equipment
                const isEquipment = currentTab === 'equipment';
                useButton.style.display = isEquipment ? 'inline-flex' : 'none';
            } else {
                useButton.style.display = 'none';
            }
        }

        async function useSelectedItem() {
            if (!selectedItem) {
                showToast('Ch∆∞a ch·ªçn item n√†o', 'error');
                return;
            }
            
            // Check if it's equipment item
            if (currentTab === 'equipment') {
                try {
                    const response = await apiCall('/api/equipment/equip', 'POST', {
                        item_id: selectedItem
                    });
                    
                    if (response.success) {
                        showToast(response.message, 'success');
                        
                        // Update user data
                        const userData = getUserData();
                        userData.equipment = response.equipment;
                        userData.inventory = response.inventory;
                        updateUserData(userData);
                        
                        // Update user info display in header
                        updateUserInfoDisplay(userData);
                        
                        // Close inventory modal
                        document.getElementById('inventoryModal').style.display = 'none';
                        
                        // Open player info modal with updated equipment
                        setTimeout(async () => {
                            await showPlayerInfo();
                        }, 200); // Small delay for smooth transition
                        
                    } else {
                        showToast(response.message, 'error');
                    }
                } catch (error) {
                    console.error('Error equipping item:', error);
                    showToast('L·ªói khi trang b·ªã item', 'error');
                }
            } else {
                // TODO: Implement other item types (consumables, etc.)
                showToast('T√≠nh nƒÉng s·ª≠ d·ª•ng item n√†y ch∆∞a ƒë∆∞·ª£c tri·ªÉn khai', 'info');
            }
        }

        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function() {
            const userData = getUserData();
            if (!userData) {
                window.location.href = '/';
                return;
            }
            
            // Load buildings and render them
            loadBuildings();
            updateUserInfoDisplay(userData);
            
            // Load equipment configuration for level calculations
            loadEquipmentConfig();
        });

        // Load and render buildings
        async function loadBuildings() {
            try {
                const response = await apiCall('/api/buildings');
                const buildings = response.buildings;
                const userData = getUserData();
                const userBuildings = userData.buildings || {};
                
                renderBuildings(buildings, userBuildings);
            } catch (error) {
                console.error('Error loading buildings:', error);
                showToast('L·ªói khi t·∫£i th√¥ng tin c√¥ng tr√¨nh', 'error');
            }
        }

        // Render buildings as cards with appropriate buttons
        function renderBuildings(buildings, userBuildings) {
            const container = document.getElementById('buildingsContainer');
            let html = '';
            
            buildings.forEach(building => {
                const userLevel = userBuildings[building.building_id] || 0;
                const isBuilt = userLevel > 0;
                const maxLevel = Object.keys(building.upgrade_material || {}).length;
                const isMaxLevel = userLevel >= maxLevel;
                
                // Building image with level indicator
                const buildingImage = `/static/img/building/${building.building_id}.png`;
                const levelText = isBuilt ? `C·∫•p ${userLevel}` : 'Ch∆∞a x√¢y';
                
                // Building card styling
                const cardClass = isBuilt ? 'building-card built' : 'building-card not-built';
                
                // Generate buttons based on building state
                let buttonsHtml = '';
                
                if (!isBuilt) {
                    // Not built - show build button
                    buttonsHtml = `
                        <button class="btn btn-success btn-icon building-action" onclick="showBuildingModal('${building.building_id}')">
                            <img src="/static/img/icon/button/build.png" alt="Build"> X√¢y d·ª±ng
                        </button>
                    `;
                } else {
                    // Built - show feature button and upgrade button (if not max level)
                    const featureButton = getBuildingFeatureButton(building.building_id);
                    
                    buttonsHtml = `
                        <div class="building-buttons">
                            ${featureButton}
                            ${!isMaxLevel ? `
                                <button class="btn btn-primary btn-icon building-action" onclick="showBuildingModal('${building.building_id}')">
                                    <img src="/static/img/icon/button/up.png" alt="Upgrade"> N√¢ng c·∫•p
                                </button>
                            ` : ''}
                        </div>
                    `;
                }
                
                html += `
                    <div class="${cardClass}" data-building-id="${building.building_id}">
                        <div class="building-level-badge ${isBuilt ? 'built' : 'not-built'}">${levelText}</div>
                        <div class="building-image">
                            <div class="building-structure" style="background-image: url('${buildingImage}');"></div>
                        </div>
                        <div class="building-info">
                            <h3 class="building-name">${building.name}</h3>
                            <p class="building-description">${building.description}</p>
                            <div class="action-buttons">
                                ${buttonsHtml}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Get feature button for each building type
        function getBuildingFeatureButton(buildingId) {
            const featureButtons = {
                'town_hall': `
                    <button class="btn btn-success btn-icon building-feature" onclick="window.location.href='/quests'">
                        <img src="/static/img/icon/button/quest.png" alt="Quests"> Nhi·ªám v·ª•
                    </button>
                `,
                'blacksmith': `
                    <button class="btn btn-success btn-icon building-feature" onclick="showBlacksmithModal()">
                        <img src="/static/img/icon/button/blacksmith.png" alt="Forge"> R√®n
                    </button>
                `,
                'market': `
                    <button class="btn btn-success btn-icon building-feature" onclick="showMarketModal()">
                        <img src="/static/img/icon/button/market.png" alt="Shop"> Ch·ª£
                    </button>
                `,
                'storage': `
                    <button class="btn btn-success btn-icon building-feature" onclick="showInventory()">
                        <img src="/static/img/icon/button/inventory.png" alt="Storage"> Kho ƒë·ªì
                    </button>
                `,
                'mage_tower': `
                    <button class="btn btn-success btn-icon building-feature" onclick="showMageTowerModal()">
                        <img src="/static/img/icon/button/mage.png" alt="Magic"> Ph√©p thu·∫≠t
                    </button>
                `
            };
            
            return featureButtons[buildingId] || '';
        }

        // Building feature functions
        function showBlacksmithModal() {
            showToast('T√≠nh nƒÉng th·ª£ r√®n ƒëang ph√°t tri·ªÉn', 'info');
            // TODO: Implement blacksmith functionality
        }

        function showMarketModal() {
            window.location.href = '/market';
        }

        function showMageTowerModal() {
            showToast('T√≠nh nƒÉng th√°p ph√©p thu·∫≠t ƒëang ph√°t tri·ªÉn', 'info');
            // TODO: Implement mage tower functionality
        }

        // Show building modal for upgrade/build
        async function showBuildingModal(buildingId) {
            try {
                const response = await apiCall('/api/buildings');
                const buildings = response.buildings;
                const building = buildings.find(b => b.building_id === buildingId);
                
                if (!building) {
                    showToast('Kh√¥ng t√¨m th·∫•y th√¥ng tin c√¥ng tr√¨nh', 'error');
                    return;
                }
                
                const userData = getUserData();
                const userLevel = userData.buildings[buildingId] || 0;
                const nextLevel = userLevel + 1;
                const upgradeInfo = building.upgrade_material[nextLevel.toString()];
                
                if (!upgradeInfo) {
                    showToast('C√¥ng tr√¨nh ƒë√£ ƒë·∫°t c·∫•p ƒë·ªô t·ªëi ƒëa', 'info');
                    return;
                }
                
                // Update modal content
                document.getElementById('modalBuildingName').textContent = building.name;
                document.getElementById('modalBuildingDescription').textContent = building.description;
                
                // Generate upgrade info HTML
                let upgradeHtml = `
                    <div class="upgrade-section">
                        <h4>
                            <img src="/static/img/icon/button/${userLevel === 0 ? 'build' : 'up'}.png" style="width: 16px; height: 16px; object-fit: contain; margin-right: 5px; vertical-align: middle;" alt="${userLevel === 0 ? 'Build' : 'Upgrade'}">
                            ${userLevel === 0 ? 'Y√™u c·∫ßu x√¢y d·ª±ng' : `N√¢ng c·∫•p l√™n c·∫•p ${nextLevel}`}
                        </h4>
                        
                        <div class="upgrade-cost">
                            <div class="cost-item">
                                <img src="/static/img/icon/info/gold.png" style="width: 16px; height: 16px; object-fit: contain; margin-right: 5px; vertical-align: middle;" alt="Gold">
                                <span>V√†ng c·∫ßn thi·∫øt: <strong>${upgradeInfo.gold}</strong></span>
                                <span class="user-gold">(Hi·ªán c√≥: ${userData.gold || 0})</span>
                            </div>
                `;
                
                if (upgradeInfo.materials && upgradeInfo.materials.length > 0) {
                    upgradeHtml += '<div class="materials-required"><h5>Nguy√™n li·ªáu c·∫ßn thi·∫øt:</h5>';
                    upgradeInfo.materials.forEach(material => {
                        const userItem = userData.inventory.find(item => item.item_id === material.item_id);
                        const userQuantity = userItem ? userItem.quantity : 0;
                        const hasEnough = userQuantity >= material.quantity;
                        
                        upgradeHtml += `
                            <div class="material-item ${hasEnough ? 'sufficient' : 'insufficient'}">
                                <img src="/static/img/icon/item/${material.item_id}.png" 
                                     style="width: 16px; height: 16px; object-fit: contain; margin-right: 5px;" 
                                     alt="Material"
                                     onerror="this.src='/static/img/icon/item/cube.png'">
                                <span>C·∫ßn: ${material.quantity}</span>
                                <span>(C√≥: ${userQuantity})</span>
                            </div>
                        `;
                    });
                    upgradeHtml += '</div>';
                }
                
                upgradeHtml += '</div></div>';
                
                document.getElementById('upgradeInfo').innerHTML = upgradeHtml;
                
                // Update upgrade button
                const upgradeButton = document.getElementById('upgradeButton');
                upgradeButton.textContent = userLevel === 0 ? 'X√¢y d·ª±ng' : 'N√¢ng c·∫•p';
                upgradeButton.innerHTML = `
                    <img src="/static/img/icon/button/${userLevel === 0 ? 'build' : 'up'}.png" alt="${userLevel === 0 ? 'Build' : 'Upgrade'}"> 
                    ${userLevel === 0 ? 'X√¢y d·ª±ng' : 'N√¢ng c·∫•p'}
                `;
                upgradeButton.onclick = () => upgradeBuildingConfirm(buildingId, nextLevel);
                
                // Show modal
                document.getElementById('buildingModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading building info:', error);
                showToast('L·ªói khi t·∫£i th√¥ng tin c√¥ng tr√¨nh', 'error');
            }
        }

        // Confirm building upgrade
        async function upgradeBuildingConfirm(buildingId, level) {
            try {
                const response = await apiCall('/api/upgrade-building', 'POST', {
                    building_id: buildingId,
                    level: level
                });
                
                if (response.success) {
                    showToast(response.message, 'success');
                    
                    // Update user data
                    const userData = getUserData();
                    userData.buildings[buildingId] = level;
                    userData.gold = response.new_gold;
                    userData.inventory = response.new_inventory;
                    updateUserData(userData);
                    
                    // Refresh buildings display
                    loadBuildings();
                    updateUserInfoDisplay(userData);
                    
                    // Close modal
                    closeModal();
                } else {
                    showToast(response.message, 'error');
                }
            } catch (error) {
                console.error('Error upgrading building:', error);
                showToast('L·ªói khi n√¢ng c·∫•p c√¥ng tr√¨nh', 'error');
            }
        }
    </script>
</body>
</html>
